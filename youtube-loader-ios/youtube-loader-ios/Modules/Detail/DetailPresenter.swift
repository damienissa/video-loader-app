//
//  DetailPresenter.swift
//  youtube-loader-ios
//
//  Created by Dima Virych on 26.01.2020.
//  Copyright (c) 2020 Virych. All rights reserved.
//
//  This file was generated by the ðŸ VIPER generator
//

import UIKit
import AVFoundation

final class DetailPresenter {

    // MARK: - Private properties -

    private unowned let view: DetailViewInterface
    private let interactor: DetailInteractorInterface
    private let wireframe: DetailWireframeInterface
    
    var viewModel: VideoViewModel!
    
    var currentExt: String!
    

    // MARK: - Lifecycle -

    init(view: DetailViewInterface, interactor: DetailInteractorInterface, wireframe: DetailWireframeInterface) {
        self.view = view
        self.interactor = interactor
        self.wireframe = wireframe
        
        interactor.output = { [weak self] url in
            self?.process(local: url)
        }
    }
}

// MARK: - Extensions -

extension DetailPresenter: DetailPresenterInterface {
    
    var imageURL: URL? {
        
        URL(string: viewModel.thumbnail)
    }
    
    var numberOfRows: Int {
    
        viewModel.streams.count
    }
    
    func title(for row: Int) -> String {
        
        viewModel.streams[row].resolution
    }
    
    func download(at row: Int) {
        
        if let url = URL(string: viewModel.streams[row].url) {
            
            currentExt = viewModel.streams[row].extension
            interactor.download(url)
        }
    }
    
    func move(file url: URL) -> URL? {
        
        guard let documentsDirectoryURL = FileManager.default.urls(for: .documentDirectory, in: .userDomainMask).first else {
            return nil
        }
        
        let destinationURL = documentsDirectoryURL.appendingPathComponent(UUID().uuidString).appendingPathExtension(currentExt)
        
        try? FileManager.default.moveItem(at: url, to: destinationURL)
        
        return destinationURL
    }
    
    func process(local url: URL?) {
        
        guard let url = move(file: url!) else {
            return
        }
        
        DispatchQueue.main.async { [weak self] in
            let activityViewController = UIActivityViewController(activityItems: [url, "Check this out!"], applicationActivities: nil)
            self?.wireframe.viewController.present(activityViewController, animated: true)
        }
    }
}
